rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function: Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // Helper function: Check if user owns the document
    function isOwner(uid) {
      return isAuth() && request.auth.uid == uid;
    }
    
    // ====================================================================
    // users/{uid} - User profile documents
    // Read/write only by the owner
    // ====================================================================
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if false; // No self-deletion
    }
    
    // ====================================================================
    // inventories/{uid} - Inventory parent document
    // Read/write only by the owner
    // MUST exist before items subcollection can be written
    // ====================================================================
    match /inventories/{uid} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
      
      // inventories/{uid}/items/{itemId} - Inventory items subcollection
      match /items/{itemId} {
        allow read: if isOwner(uid);
        allow write: if isOwner(uid);
      }
    }
    
    // ====================================================================
    // scans/{uid}/runs/{scanId} - Scan run tracking
    // Read/write only by the owner
    // ====================================================================
    match /scans/{uid}/runs/{scanId} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }
    
    // ====================================================================
    // meals/{uid}/generated/{mealId} - AI-generated meals
    // Read/write only by the owner
    // ====================================================================
    match /meals/{uid}/generated/{mealId} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }
    
    // ====================================================================
    // userEntitlements/{uid} - Subscription and usage tracking
    // Read by owner, write ONLY by admin (via backend)
    // ====================================================================
    match /userEntitlements/{uid} {
      allow read: if isOwner(uid);
      allow write: if false; // Only backend/admin can write
    }
    
    // ====================================================================
    // Legacy/Admin collections (temporary compatibility)
    // ====================================================================
    
    // sessions/{sessionId} - Upload session tracking (temporary, to be migrated to scans)
    match /sessions/{sessionId} {
      allow read, write: if isAuth();
    }
    
    // recipeImages/{imageId} - Recipe image metadata (admin-managed)
    match /recipeImages/{imageId} {
      allow read: if isAuth();
      allow write: if false; // Admin only
    }
    
    // pro_waitlist/{uid} - Pro tier waitlist (legacy)
    match /pro_waitlist/{uid} {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }
    
    // ====================================================================
    // Deny all other paths by default
    // ====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
